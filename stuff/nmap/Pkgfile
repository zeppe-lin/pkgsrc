# Description: Network exploration of security auditing + unofficial nse scripts
# URL:         https://nmap.org
# Depends on:  ktsuss libpcap pygtk

name=nmap
version=7.93
release=1
source="https://nmap.org/dist/nmap-$version.tar.bz2
	0001-fix-hardcoded-monospace-font.patch
	0002-fix-highlight.patch
	nmap-7.93-openssl-1.1.patch
	src/*.nse"

build() {
	# build in separate dir is broken
	cd $name-$version

	patch -p1 -i $SRC/0001-fix-hardcoded-monospace-font.patch
	patch -p1 -i $SRC/0002-fix-highlight.patch
	patch -p1 -i $SRC/nmap-7.93-openssl-1.1.patch

	./configure                    \
		--prefix=/usr          \
		--libexecdir=/usr/lib  \
		--with-libpcap=/usr    \
		--with-libpcre=/usr    \
		--with-zlib=/usr       \
		--without-nmap-update  \
		--disable-nls          \

	make V=1
	make DESTDIR=$PKG install

	# add a launcher to run zenmap as root
	ln -s /usr/share/zenmap/su-to-zenmap.sh $PKG/usr/bin/zenmap-su

	# add unofficial nse scripts
	for nse in $SRC/*.nse; do
		install -m 644 -D $nse $PKG/usr/share/nmap/scripts/${nse#*-}
		categories="$(grep -Eo 'categories[[:space:]]+=[[:space:]]{.*}' $nse ||:)"
		if [ -n "$categories" ]; then
			cat >> $PKG/usr/share/nmap/scripts/script.db <<EOF
Entry { filename = "${nse#*-}", ${categories} }
EOF
		else
			echo "WARNING: $nse missing categories!"
		fi
	done

	# fix error "PangoFc will not work correctly"
	mkdir -p $PKG/usr/etc/pango
	pango-querymodules > $PKG/usr/etc/pango/pango.modules

	# remove junk
	rm -r $PKG/usr/share/zenmap/locale $PKG/usr/share/zenmap/docs
	rm $PKG/usr/share/nmap/nselib/data/psexec/README          \
	   $PKG/usr/share/nmap/nselib/data/jdwp-class/README.txt  \
	   $PKG/usr/bin/uninstall_*
}
